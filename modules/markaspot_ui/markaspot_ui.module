<?php

/**
 * @file
 * Provides a toolbar integration for Mark-a-Spot modules.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * Implements hook_help().
 */
function markaspot_ui_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.markaspot_ui':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Mark-a-Spot UI module provides a consolidated toolbar interface for accessing all Mark-a-Spot module settings.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_toolbar().
 */
function markaspot_ui_toolbar() {
  if (!\Drupal::currentUser()->hasPermission('administer site configuration')) {
    return [];
  }

  // Build the toolbar item.
  $items['markaspot'] = [
    '#type' => 'toolbar_item',
    '#weight' => 99,
    'tab' => [
      '#type' => 'link',
      '#title' => t('Mark-a-Spot'),
      '#url' => Url::fromRoute('markaspot_ui.settings'),
      '#attributes' => [
        'title' => t('Mark-a-Spot settings'),
        'class' => ['toolbar-icon', 'toolbar-icon-markaspot-ui'],
      ],
    ],
    'tray' => [
      '#heading' => t('Mark-a-Spot settings'),
      'content' => [
        '#lazy_builder' => ['markaspot_ui.toolbar_builder:buildToolbarTray', []],
        '#create_placeholder' => TRUE,
      ],
    ],
    '#attached' => [
      'library' => ['markaspot_ui/toolbar'],
    ],
    '#cache' => [
      'contexts' => ['user.permissions'],
    ],
  ];

  return $items;
}

/**
 * Implements hook_theme().
 */
function markaspot_ui_theme() {
  return [
    'markaspot_ui_settings_overview' => [
      'variables' => [
        'modules' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_modules_installed().
 */
function markaspot_ui_modules_installed($modules) {
  // Clear caches when modules are installed to update the toolbar.
  Cache::invalidateTags(['markaspot_ui']);
}

/**
 * Implements hook_modules_uninstalled().
 */
function markaspot_ui_modules_uninstalled($modules) {
  // Clear caches when modules are uninstalled to update the toolbar.
  Cache::invalidateTags(['markaspot_ui']);
}

/**
 * Implements hook_menu_local_tasks_alter().
 */
function markaspot_ui_menu_local_tasks_alter(&$data, $route_name) {
  // Override the View tab link for service request nodes to point to frontend.
  if ($route_name == 'entity.node.edit_form' && isset($data['tabs'][0]['entity.node.canonical'])) {
    $node = \Drupal::routeMatch()->getParameter('node');
    if ($node && $node->bundle() == 'service_request' && !empty($node->request_id->value)) {
      // Get frontend URL from config, fallback to localhost.
      $frontend_url = \Drupal::config('markaspot_nuxt.settings')->get('frontend_base_url') ?: 'http://localhost:3000';
      $frontend_url = rtrim($frontend_url, '/');
      $data['tabs'][0]['entity.node.canonical']['#link']['url'] = Url::fromUri($frontend_url . '/requests/' . $node->request_id->value);
    }
  }
}