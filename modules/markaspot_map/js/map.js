!function(e){var t={};function o(a){if(t[a])return t[a].exports;var r=t[a]={i:a,l:!1,exports:{}};return e[a].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,a){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(o.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(a,r,function(t){return e[t]}.bind(null,r));return a},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";L.TimeDimension.Layer.MaS=L.TimeDimension.Layer.GeoJson.extend({_update:function(){if(this._map&&this._loaded){var e=this._timeDimension.getCurrentTime(),t=dateFormat(e,Drupal.Markaspot.settings.timeline_date_format),o=this._timeDimension.getCurrentTime(),a=0;if(this._duration){var r=new Date(o);L.TimeDimension.Util.subtractTimeDuration(r,this._duration,!0),a=r.getTime()}for(var n=L.geoJson(null,this._baseLayer.options),i=this._baseLayer.getLayers(),s=0,l=i.length;s<l;s++){var m=this._getFeatureBetweenDates(i[s].feature,a,o);if(m&&(n.addData(m),this._addlastPoint&&"LineString"===m.geometry.type&&m.geometry.coordinates.length>0)){var c=m.properties.properties;c.last=!0,n.addData({type:"Feature",properties:c,geometry:{type:"Point",coordinates:m.geometry.coordinates[m.geometry.coordinates.length-1]}})}}if(this._currentLayer&&this._map.removeLayer(this._currentLayer),n.getLayers().length){var u=n.getLayers().length,p=jQuery("ul.log_list");p.append('<li><span class="time">'+t+'</span> <span class="count">'+u+"</span>");var d=p.get(0).scrollHeight;p.animate({scrollTop:d},10),n.addTo(this._map),this._currentLayer=n}}}}),function(e,t,o){t.Markaspot={},t.Markaspot.maps=[];var a=void 0,r=[];t.behaviors.markaspot_map={attach:function(n,i){var s=i.mas;t.Markaspot.settings=s,e("#map").once("markaspot_map").each(function(){e(".log_header .left").text(t.t("Date")),e(".log_header .right").text(t.t("Requests")),t.Markaspot.maps[0]=L.map("map",{fullscreenControl:!0,scrollWheelZoom:!1,maxZoom:18,setZoom:14}),e("#map").css("background-color:"+s.map_background);var r=L.tileLayer(s.osm_custom_tile_url),n=t.Markaspot.maps[0];n.attributionControl.addAttribution(s.osm_custom_attribution),n.addLayer(r),a=L.markerClusterGroup({maxClusterRadius:20}),n.addLayer(a);var i=o.path.currentPath;if("node"===i&&(t.markaspot_map.createHeatMapLayer(n),t.markaspot_map.setDefaults(s)),(i="/"+i)===s.visualization_path||"/home"===i){console.log(i);var l=t.markaspot_map.createGeoJsonTimedLayer(n),m=[[s.center_lat,s.center_lng,1]],c=new L.HeatLayer(m).addTo(n);c.id="heatTimedLayer";var u=t.markaspot_map.showTimeController(n);L.easyButton({position:"bottomright",states:[{stateName:"add-heatControls",icon:"fa-thermometer-4",title:t.t("Show Heatmap"),onClick:function(e){t.markaspot_map.showTimeController(n),t.markaspot_map.createGeoJsonTimedLayer(n),e.state("remove-heatControls"),e.heatMapLayer=t.markaspot_map.createHeatMapLayer(n),e.heatMapLayer.addTo(n)}},{stateName:"remove-heatControls",icon:"fa-thermometer-4 active",title:t.t("Hide Heatmap"),onClick:function(e){n.removeLayer(e.heatMapLayer),e.state("add-heatControls")}}]}).addTo(n),L.easyButton({position:"bottomright",states:[{stateName:"add-timeControls",icon:"fa-clock-o",title:t.t("Show TimeControl Layer"),onClick:function(t){e("div.log").show(),t.state("remove-timeControls"),n.addControl(u),c.addTo(n),l.addTo(n)}},{icon:"fa-clock-o active",stateName:"remove-timeControls",title:t.t("Remove TimeControl Layer"),onClick:function(t){e("div.log").hide(),n.removeControl(u),n.removeLayer(l),n.removeLayer(c),t.state("add-timeControls"),e("ul.log_list").empty()}}]}).addTo(n)}localStorage.setItem("storedNids",JSON.stringify(""))});var l=JSON.parse(localStorage.getItem("storedNids")),m=t.markaspot_map.getNids(s.nid_selector);m.length||t.markaspot_map.setDefaults(s),JSON.stringify(m)!==JSON.stringify(l)&&(localStorage.setItem("storedNids",JSON.stringify(m)),a.clearLayers(),t.markaspot_map.load(function(e){t.markaspot_map.showData(e),a.eachLayer(function(e){var t=e.options.title;r[t]={latlng:e.getLatLng(),title:e.options.title,color:e.options.color}})},m));for(var c=e(s.nid_selector),u=0,p=c.length;u<p;u++)e(c[u]).hover(function(){var e=this.getAttribute("data-history-node-id");t.markaspot_map.showCircle(r[e])}),new Waypoint({element:c[u],handler:function(){var o=this.element.getAttribute("data-history-node-id"),a=this.previous(),n=this.next();a&&e(a.element).removeClass("focus"),n&&e(n.element).removeClass("focus"),e(this.element).addClass("focus"),r.hasOwnProperty(o)&&t.markaspot_map.showCircle(r[o])},offset:"40%"})}},t.markaspot_map={setDefaults:function(e){var o=new L.LatLng(e.center_lat,e.center_lng);t.Markaspot.maps[0].setView(o,e.zoom_initial)},showCircle:function(e){var o=t.Markaspot.maps[0],a=o.getZoom();if(void 0!==e){var r=e.color,n=L.circle(e.latlng,300/a,{color:r,weight:1,fillColor:r,fillOpacity:.3,opacity:.7}).addTo(o);o.panTo(e.latlng,{animate:!0,duration:.4}),setTimeout(function(){o.removeLayer(n)},1300)}},showTimeController:function(e){var t=new L.TimeDimension({period:o.mas.timeline_period});return e.timeDimension=t,L.Control.TimeDimensionCustom=L.Control.TimeDimension.extend({_getDisplayDateFormat:function(e){return this._dateUTC?e.toISOString():e.toLocaleString()},options:{position:"bottomright",minSpeed:.1,maxSpeed:50,speedStep:1,timeSteps:1,displayDate:!0,autoPlay:!0,timeSlider:!1,loopButton:!0,playerOptions:{transitionTime:125,loop:!0}}}),new L.Control.TimeDimensionCustom},trendMarker:function(e){a.clearLayers();var o=t.markaspot_static_json.getData(),r=e.substr(1).replace("/","-"),n=o.filter(function(e){return e.requested_datetime.indexOf(r)>-1}),i=this.createGeoJson(n),s=t.markaspot_map.transformGeoJson2heat(i,4),l=new L.HeatLayer(s,{});a.addLayer(l),this.showMarkers()},createGeoJson:function(e){if(void 0!==e){var t=void 0,o=[];if(e.length)for(var a=0;a<e.length;a++)t={type:"Feature",properties:{time:e[a].requested_datetime},geometry:{type:"Point",coordinates:[e[a].long,e[a].lat]}},o.push(t);return{type:"FeatureCollection",features:o}}},retrieveStaticData:function(){return t.markaspot_static_json.getData()},createGeoJsonLayer:function(t){var o=this.retrieveStaticData(),a=this.createGeoJson(o);t.fitBounds(L.geoJson(a).getBounds());var r=t.getZoom();if(void 0!==a)return L.geoJson(a,{pointToLayer:function(o,a){var n=L.circle(a,3600/r,{color:"#333",className:"auto_hide",weight:1,fillColor:"#333",fillOpacity:.2});return setTimeout(function(){e(".auto_hide").animate({opacity:0},500,function(){t.removeLayer(n)})},3e3),n}})},createGeoJsonTimedLayer:function(e){var a=t.markaspot_map.createGeoJsonLayer(e);if(void 0!==a)return new L.TimeDimension.Layer.MaS(a,{updateTimeDimension:!0,duration:o.mas.timeline_period})},transformGeoJson2heat:function(e,t){return e.features.map(function(e){return[e.geometry.coordinates[1],e.geometry.coordinates[0],t]})},updateHeatMapLayer:function(e){var o={};t.Markaspot.maps[0].eachLayer(function(e){"heatTimedLayer"===e.id&&(o=e)}),o.addLatLng(e)},createHeatMapLayer:function(){var e=this.retrieveStaticData(),t=this.createGeoJson(e),o=this.transformGeoJson2heat(t,4);return new L.HeatLayer(o,{blur:25,maxZoom:17})},hideMarkers:function(){t.Markaspot.maps[0].closePopup(),t.Markaspot.maps[0].removeLayer(a)},showMarkers:function(){t.Markaspot.maps[0].addLayer(a)},markerClickFn:function(o,a){return function(){var r=t.Markaspot.maps[0],n=r.getZoom(),i=r.isFullscreen(),s=e("article[data-history-node-id="+a+"]");if(s.length&&!1===i)r.setZoom(n+2),e("html, body").stop().animate({scrollTop:s.offset().top-200},1e3);else if(s.length&&!0===i){var l=s.text();o.bindPopup(l)}}},getAwesomeColors:function(){return[{color:"red",hex:"#FF0000"},{color:"darkred",hex:"#8B0000"},{color:"orange",hex:"#FFA500",iconColor:"dark-red"},{color:"green",hex:"#008000"},{color:"darkgreen",hex:"#006400"},{color:"blue",hex:"#0000FF"},{color:"darkblue",hex:"#00008B"},{color:"purple",hex:"#A020F0"},{color:"darkpurple",hex:"#871F78"},{color:"cadetblue",hex:"#5F9EA0"},{color:"lightblue",hex:"#ADD8E6",iconColor:"#000000"},{color:"lightgray",hex:"#D3D3D3",iconColor:"#000000"},{color:"gray",hex:"#808080"},{color:"black",hex:"#000000"},{color:"beige",hex:"#F5F5DC",iconColor:"darkred"},{color:"white",hex:"#FFFFFF",iconColor:"#000000"}]},showData:function(o){var r=this;if(404===o.status)return!1;var n=this.getAwesomeColors();return e.each(o,function(t,o){var i=o.extended_attributes.markaspot.category_hex,s=i?i.toUpperCase():"#000000";e.each(n,function(e,t){if(s===t.hex){var n=t.color,l=o.extended_attributes.markaspot.category_icon,m=t.iconColor?t.iconColor:"#ffffff",c=L.AwesomeMarkers.icon({icon:l,prefix:"fa",markerColor:n,iconColor:m}),u=o.extended_attributes.markaspot.nid,p=i,d=new L.LatLng(o.lat,o.long),f=new L.Marker(d,{icon:c,title:u,color:p,time:o.requested_datetime});f.on("click",r.markerClickFn(f,u)),a.addLayer(f)}})}),a.getLayers().length>=1?t.Markaspot.maps[0].fitBounds(a.getBounds(),{padding:[-150,-150]}):t.Markaspot.maps[0].setView(a),a},load:function(t,a){var r=o.path.baseUrl;return r=r+"georeport/v2/requests.json?extensions=true&nids="+a,e.getJSON(r).done(function(e){t(e)}).fail(function(e){t(e)})},getNids:function(t){for(var o=e(t),a=[],r=0,n=o.length;r<n;r++){var i=o[r];a.push(i.getAttribute("data-history-node-id"))}return a}}}(jQuery,Drupal,drupalSettings)}]);