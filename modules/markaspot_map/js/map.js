/**
* DO NOT EDIT THIS FILE.
* See the following change record for more information,
* https://www.drupal.org/node/2815083
* @preserve
**/

function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

L.TimeDimension.Layer.MaS = L.TimeDimension.Layer.GeoJson.extend({
  _update: function _update() {
    if (!this._map) {
      return;
    }

    if (!this._loaded) {
      return;
    }

    var requestTime = this._timeDimension.getCurrentTime();

    var formatTime = dateFormat(requestTime, Drupal.Markaspot.settings.timeline_date_format);

    var maxTime = this._timeDimension.getCurrentTime();

    var minTime = 0;

    if (this._duration) {
      var date = new Date(maxTime);
      L.TimeDimension.Util.subtractTimeDuration(date, this._duration, true);
      minTime = date.getTime();
    }

    var layer = L.geoJson(null, this._baseLayer.options);

    var layers = this._baseLayer.getLayers();

    for (var i = 0, l = layers.length; i < l; i++) {
      var feature = this._getFeatureBetweenDates(layers[i].feature, minTime, maxTime);

      if (feature) {
        layer.addData(feature);

        if (this._addlastPoint && feature.geometry.type === "LineString") {
          if (feature.geometry.coordinates.length > 0) {
            var properties = feature.properties.properties;
            properties.last = true;
            layer.addData({
              type: "Feature",
              properties: properties,
              geometry: {
                type: "Point",
                coordinates: feature.geometry.coordinates[feature.geometry.coordinates.length - 1]
              }
            });
          }
        }
      }
    }

    if (this._currentLayer) {
      this._map.removeLayer(this._currentLayer);
    }

    if (layer.getLayers().length) {
      var requests = layer.getLayers().length;
      var log = jQuery("ul.log_list");
      log.append("<li><span class=\"time\">".concat(formatTime, "</span> <span class=\"count\">").concat(requests, "</span>"));
      var height = log.get(0).scrollHeight;
      log.animate({
        scrollTop: height
      }, 10);
      layer.addTo(this._map);
      this._currentLayer = layer;
    }
  }
});

function invertColor(hex, bw) {
  if (hex.indexOf('#') === 0) {
    hex = hex.slice(1);
  }

  if (hex.length === 3) {
    hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
  }

  if (hex.length !== 6) {
    throw new Error('Invalid HEX color.');
  }

  var r = parseInt(hex.slice(0, 2), 16),
      g = parseInt(hex.slice(2, 4), 16),
      b = parseInt(hex.slice(4, 6), 16);

  if (bw) {
    return r * 0.299 + g * 0.587 + b * 0.114 > 186 ? '#000000' : '#FFFFFF';
  }

  r = (255 - r).toString(16);
  g = (255 - g).toString(16);
  b = (255 - b).toString(16);
  return "#" + padZero(r) + padZero(g) + padZero(b);
}

function padZero(str, len) {
  len = len || 2;
  var zeros = new Array(len).join('0');
  return (zeros + str).slice(-len);
}

(function ($, Drupal, drupalSettings) {
  Drupal.Markaspot = {};
  Drupal.Markaspot.maps = [];
  var markerLayer;
  var scrolledMarker = [];
  var currentPath = drupalSettings.path.currentPath;
  currentPath = "/".concat(currentPath);
  var masSettings = drupalSettings.mas;
  Drupal.behaviors.markaspot_map = {
    attach: function attach(context, settings) {
      Drupal.Markaspot.settings = masSettings;
      var mapSelector = $("#map");

      if (typeof mapSelector === 'undefined') {
        return;
      }

      mapSelector.once("markaspot_map").each(function () {
        $(".log_header .left").text(Drupal.t("Date"));
        $(".log_header .right").text(Drupal.t("Requests"));
        Drupal.Markaspot.maps[0] = L.map("map", {
          fullscreenControl: true,
          scrollWheelZoom: !L.Browser.mobile,
          minZoom: 12,
          maxZoom: 18,
          dragging: !L.Browser.mobile,
          zoom: masSettings.zoom_initial
        });
        $("#map").css("background-color:".concat(masSettings.map_background));
        var tileLayer;
        var map = Drupal.Markaspot.maps[0];

        if (masSettings.map_type === "0") {
          var gl = L.mapboxGL({
            accessToken: masSettings.mapbox_token,
            style: masSettings.mapbox_style
          }).addTo(map);
        }

        if (masSettings.map_type === "1") {
          if (masSettings.wms_service == '') {
            tileLayer = L.tileLayer(masSettings.osm_custom_tile_url, {
              edgeBufferTiles: 1
            });
          } else {
            tileLayer = L.tileLayer.wms(masSettings.wms_service, {
              layers: masSettings.wms_layer,
              edgeBufferTiles: 1
            });
          }

          map.addLayer(tileLayer);
        }

        map.attributionControl.addAttribution(masSettings.osm_custom_attribution);
        markerLayer = L.markerClusterGroup({
          maxClusterRadius: 20
        });
        map.addLayer(markerLayer);

        if (currentPath === "/node") {
          Drupal.markaspot_map.createHeatMapLayer(map);
          Drupal.markaspot_map.setDefaults();
        }

        if (currentPath === masSettings.visualization_path || currentPath === "/home") {
          var geoJsonTimedLayer = Drupal.markaspot_map.createGeoJsonTimedLayer(map);
          var heatStart = [[masSettings.center_lat, masSettings.center_lng, 1]];
          var heatLayer = new L.HeatLayer(heatStart).addTo(map);
          heatLayer.id = "heatTimedLayer";
          var heatControls = L.easyButton({
            position: "bottomright",
            states: [{
              stateName: "add-heatControls",
              icon: "fa-thermometer-4",
              title: Drupal.t("Show Heatmap"),
              onClick: function onClick(control) {
                Drupal.markaspot_map.createGeoJsonTimedLayer(map);
                control.state("remove-heatControls");
                control.heatMapLayer = Drupal.markaspot_map.createHeatMapLayer();
                control.heatMapLayer.addTo(map);
              }
            }, {
              stateName: "remove-heatControls",
              icon: "fa-thermometer-4 active",
              title: Drupal.t("Hide Heatmap"),
              onClick: function onClick(control) {
                map.removeLayer(control.heatMapLayer);
                control.state("add-heatControls");
              }
            }]
          });
          heatControls.addTo(map);
          var timeDimensionControl = Drupal.markaspot_map.showTimeController(map);
          var timeControls = L.easyButton({
            position: "bottomright",
            states: [{
              stateName: "add-timeControls",
              icon: "fa-clock-o",
              title: Drupal.t("Show TimeControl Layer"),
              onClick: function onClick(control) {
                $("div.log").show();
                control.state("remove-timeControls");
                map.addControl(timeDimensionControl);
                heatLayer.addTo(map);
                geoJsonTimedLayer.addTo(map);
              }
            }, {
              icon: "fa-clock-o active",
              stateName: "remove-timeControls",
              title: Drupal.t("Remove TimeControl Layer"),
              onClick: function onClick(control) {
                $("div.log").hide();
                map.removeControl(timeDimensionControl);
                map.removeLayer(geoJsonTimedLayer);
                map.removeLayer(heatLayer);
                control.state("add-timeControls");
                $("ul.log_list").empty();
              }
            }]
          });
          timeControls.addTo(map);
        }

        localStorage.setItem("storedNids", JSON.stringify(""));
      });
      var storedNids = JSON.parse(localStorage.getItem("storedNids"));
      var nids = Drupal.markaspot_map.getNids(masSettings.nid_selector);

      if (!nids.length) {
        Drupal.markaspot_map.setDefaults(masSettings);
      }

      if (JSON.stringify(nids) !== JSON.stringify(storedNids)) {
        localStorage.setItem("storedNids", JSON.stringify(nids));

        if (typeof markerLayer !== "undefined") {
          markerLayer.clearLayers();
          Drupal.markaspot_map.load(function (data) {
            Drupal.markaspot_map.showData(data);
            markerLayer.eachLayer(function (layer) {
              var nid = layer.options.nid;
              scrolledMarker[nid] = {
                latlng: layer.getLatLng(),
                nid: layer.options.nid,
                color: layer.options.color
              };
            });
          }, nids);
        }
      }

      var $serviceRequests = $(masSettings.nid_selector);
      $serviceRequests.hover(function () {
        var nid = this.dataset.historyNodeId;
        var $node = this;
        scrolledMarker.forEach(function (value) {
          if (value["nid"] == nid) {
            $node.classList.toggle("focus");
            Drupal.markaspot_map.showCircle(scrolledMarker[nid]);
          }
        });
      });
      $('.view-content').once('markaspot_map').each(function () {
        $serviceRequests.each(function () {
          new Waypoint({
            element: this,
            handler: function handler(direction) {
              var nid = this.element.dataset.historyNodeId;

              if (typeof scrolledMarker[nid] !== "undefined") {
                Drupal.markaspot_map.showCircle(scrolledMarker[nid]);
                this.element.classList.add("focus");
              } else {
                this.element.classList.add("no-location");
                Drupal.Markaspot.maps[0].setView([masSettings.center_lat, masSettings.center_lng], 10);
                return;
              }

              if (direction === "up") {
                this.element.classList.remove("focus");
              }
            },
            offset: "40%"
          });
        });
      });
    }
  };
  Drupal.markaspot_map = {
    setDefaults: function setDefaults() {
      var defaultCenter = new L.LatLng(masSettings.center_lat, masSettings.center_lng);
      var map = Drupal.Markaspot.maps[0];

      if (typeof map !== "undefined") {
        map.setView(defaultCenter, masSettings.zoom_initial);
      }
    },
    showHeatMap: function showHeatMap() {
      var map = Drupal.Markaspot.maps[0];
      Drupal.markaspot_map.createGeoJsonTimedLayer(map);
      Drupal.Markaspot.heatMapLayer = Drupal.markaspot_map.createHeatMapLayer();
      Drupal.Markaspot.heatMapLayer.addTo(map);
    },
    hideHeatMap: function hideHeatMap() {
      var map = Drupal.Markaspot.maps[0];
      map.removeLayer(Drupal.Markaspot.heatMapLayer);
    },
    showTimeControl: function showTimeControl() {
      $("div.log").show();
      var map = Drupal.Markaspot.maps[0];
      Drupal.markaspot_map.timeDimensionControl = Drupal.markaspot_map.showTimeController(map);
      map.addControl(Drupal.markaspot_map.timeDimensionControl);
      var geoJsonTimedLayer = Drupal.markaspot_map.createGeoJsonTimedLayer(map);
      Drupal.Markaspot.geoJsonTimedLayer = geoJsonTimedLayer;
      Drupal.Markaspot.geoJsonTimedLayer.addTo(map);
    },
    hideTimeControl: function hideTimeControl() {
      var map = Drupal.Markaspot.maps[0];
      $("div.log").hide();
      var timeDimensionControl = Drupal.markaspot_map.showTimeController(map);
      map.removeControl(Drupal.markaspot_map.timeDimensionControl);
      map.removeLayer(Drupal.Markaspot.geoJsonTimedLayer);
      $("ul.log_list").empty();
    },
    showCircle: function showCircle(marker) {
      var markerId = marker.nid;

      if (_typeof(markerId) === undefined || markerId === this.marker) {
        return;
      }

      this.marker = markerId;
      var map = Drupal.Markaspot.maps[0];
      var currentZoom = map.getZoom();
      var mapDefaultZoom = masSettings.zoom_initial;

      if (typeof marker === "undefined") {
        return;
      }

      var color = marker.color;
      var circle = L.circle(marker.latlng, 3600 / mapDefaultZoom, {
        color: color,
        className: "auto_hide",
        weight: 1,
        fillColor: color,
        fillOpacity: 0.2
      }).addTo(map);
      map.flyTo(marker.latlng, mapDefaultZoom, {
        duration: 0.8
      });
      map.invalidateSize();
      setTimeout(function () {
        $(".auto_hide").animate({
          opacity: 0
        }, 500, function () {
          map.removeLayer(circle);
        });
      }, 1000);
      return circle;
    },
    showTimeController: function showTimeController() {
      var map = Drupal.Markaspot.maps[0];
      map.timeDimension = new L.TimeDimension({
        period: drupalSettings.mas.timeline_period
      });
      L.Control.TimeDimensionCustom = L.Control.TimeDimension.extend({
        _getDisplayDateFormat: function _getDisplayDateFormat(date) {
          return this._dateUTC ? date.toISOString() : date.toLocaleString();
        },
        options: {
          position: "bottomright",
          minSpeed: 0.1,
          maxSpeed: 50,
          speedStep: 1,
          timeSteps: 1,
          displayDate: true,
          autoPlay: true,
          timeSlider: false,
          loopButton: true,
          playerOptions: {
            transitionTime: 125,
            loop: true
          }
        }
      });
      return new L.Control.TimeDimensionCustom();
    },
    createGeoJson: function createGeoJson(data) {
      if (typeof data !== "undefined") {
        var feature;
        var features = [];

        if (data.length) {
          for (var i = 0; i < data.length; i++) {
            feature = {
              type: "Feature",
              properties: {
                time: data[i].requested_datetime
              },
              geometry: {
                type: "Point",
                coordinates: [data[i].long, data[i].lat]
              }
            };
            features.push(feature);
          }
        }

        return {
          type: "FeatureCollection",
          features: features
        };
      }
    },
    retrieveStaticData: function retrieveStaticData() {
      return Drupal.markaspot_static_json.getData();
    },
    createGeoJsonLayer: function createGeoJsonLayer(map) {
      var data = this.retrieveStaticData();
      var geoJson = this.createGeoJson(data);
      map.fitBounds(L.geoJson(geoJson).getBounds());
      var currentZoom = map.getZoom();

      if (typeof geoJson !== "undefined") {
        return L.geoJson(geoJson, {
          pointToLayer: function pointToLayer(feature, latlng) {
            var circle = L.circle(latlng, 3600 / currentZoom, {
              color: "#333",
              className: "auto_hide",
              weight: 1,
              fillColor: "#333",
              fillOpacity: 0.2
            });
            setTimeout(function () {
              $(".auto_hide").animate({
                opacity: 0
              }, 500, function () {
                map.removeLayer(circle);
              });
            }, 3000);
            return circle;
          }
        });
      }
    },
    createGeoJsonTimedLayer: function createGeoJsonTimedLayer(map) {
      var geoJsonLayer = Drupal.markaspot_map.createGeoJsonLayer(map);

      if (typeof geoJsonLayer !== "undefined") {
        return new L.TimeDimension.Layer.MaS(geoJsonLayer, {
          updateTimeDimension: true,
          duration: drupalSettings.mas.timeline_period
        });
      }
    },
    transformGeoJson2heat: function transformGeoJson2heat(geojson, intensity) {
      return geojson.features.map(function (feature) {
        return [feature.geometry.coordinates[1], feature.geometry.coordinates[0], intensity];
      });
    },
    updateHeatMapLayer: function updateHeatMapLayer(heatPoint) {
      var heatLayer = {};
      var map = Drupal.Markaspot.maps[0];
      map.eachLayer(function (layer) {
        if (layer.id === "heatTimedLayer") {
          heatLayer = layer;
        }
      });
      heatLayer.addLatLng(heatPoint);
    },
    createHeatMapLayer: function createHeatMapLayer() {
      var data = this.retrieveStaticData();
      var geoJson = this.createGeoJson(data);
      var heatPoints = this.transformGeoJson2heat(geoJson, 4);
      return new L.HeatLayer(heatPoints, {
        blur: 25,
        maxZoom: 17
      });
    },
    hideMarkers: function hideMarkers() {
      Drupal.Markaspot.maps[0].closePopup();
      Drupal.Markaspot.maps[0].removeLayer(markerLayer);
    },
    showMarkers: function showMarkers() {
      Drupal.Markaspot.maps[0].addLayer(markerLayer);
    },
    markerClickFn: function markerClickFn(marker, nid) {
      return function markerClick() {
        var map = Drupal.Markaspot.maps[0];
        var currentZoom = map.getZoom();
        var fullscreen = map.isFullscreen();
        var target = $("article[data-history-node-id=".concat(nid, "]"));

        if (target.length && fullscreen === false && currentPath !== "/home") {
          map.setZoom(currentZoom + 2);
          $("html, body").stop().animate({
            scrollTop: target.offset().top - 250
          }, 1000);
        } else if (target.length && fullscreen === true || currentPath === "/home") {
          var html = target.find("h2").html();
          marker.bindPopup(html);
        }
      };
    },
    showData: function showData(dataset) {
      var _this = this;

      if (dataset.status === 404) {
        return false;
      }

      $.each(dataset, function (serviceRequests, request) {
        var categoryColor = request.extended_attributes.markaspot.category_hex;
        var awesomeIcon = request.extended_attributes.markaspot.category_icon;
        var nid = request.extended_attributes.markaspot.nid;
        var latlon = new L.LatLng(request.lat, request.long);
        var masSettings = drupalSettings.mas;
        var center = {};
        var pos = {};
        pos.long = Number(request.long.toFixed(3));
        pos.lat = Number(request.lat.toFixed(3));
        center.lat = parseFloat(masSettings.center_lat).toFixed(3);
        center.lng = parseFloat(masSettings.center_lng).toFixed(3);

        if (center.lat == pos.lat && center.lng == pos.long) {
          return;
        }

        var iconSettings = {
          mapIconUrl: masSettings.marker
        };
        iconSettings.mapIconColor = invertColor(categoryColor, 1);
        iconSettings.mapIconFill = categoryColor;
        iconSettings.mapIconSymbol = awesomeIcon;
        var svgIcon = L.Util.template(iconSettings.mapIconUrl, iconSettings);
        var icon = L.divIcon({
          html: svgIcon,
          iconAnchor: eval(masSettings.iconAnchor)
        });
        var marker = new L.Marker(latlon, {
          icon: icon,
          nid: nid
        });
        marker.on("click", _this.markerClickFn(marker, nid));
        markerLayer.addLayer(marker);
      });
      var size = markerLayer.getLayers().length;

      if (size >= 1) {
        Drupal.Markaspot.maps[0].fitBounds(markerLayer.getBounds(), {
          padding: [50, 50]
        });
      } else {
        Drupal.markaspot_map.setDefaults();
      }

      return markerLayer;
    },
    load: function load(getData, nids) {
      var url = drupalSettings.path.baseUrl;
      url = "".concat(url, "georeport/v2/requests.json?extensions=true&nids=").concat(nids);
      return $.getJSON(url).done(function (data) {
        getData(data);
      }).fail(function (data) {
        getData(data);
      });
    },
    getNids: function getNids(selector) {
      var serviceRequests = $(selector);
      var nids = [];

      for (var i = 0, length = serviceRequests.length; i < length; i++) {
        var element = serviceRequests[i];
        nids.push(element.getAttribute("data-history-node-id"));
      }

      return nids;
    }
  };
})(jQuery, Drupal, drupalSettings);