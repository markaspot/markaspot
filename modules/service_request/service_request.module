<?php

/**
 * @file
 * Contains service_request.module.
 *
 * This is a content type to run an georeport v2 server.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\paragraphs\Entity\Paragraph;


/**
 * Implements hook_node_presave().
 */
function service_request_node_presave(EntityInterface $node) {

  // Service Request Creation.
  if ($node->bundle() == 'service_request' && !$node->id()) {
    // Get some relevant config.
    $config = \Drupal::configFactory()
      ->getEditable('markaspot_open311.settings');
    // Add an intitial paragraph on post
    // Status when inserting.

    $status_open_start = $config->get('status_open_start');

    // todo: put this in config.
    $status_note_initial = t('The service request has been created.');

    $paragraph = Paragraph::create([
      'type' => 'status',
      'field_status_note' => array(
        "value" => $status_note_initial,
        'format' => 'plain_text',
      ),
      'field_status_term' => array(
        "target_id" => $status_open_start,
      ),
    ]);
    $paragraph->save();

    $node->field_status_notes = array(
      array(
        'target_id' => $paragraph->id(),
        'target_revision_id' => $paragraph->getRevisionId(),
      ),
    );
    $node->field_status = array(
      array(
        'target_id' =>  $status_open_start,
      ),
    );
  }
  // Service Request Update
  elseif ($node->bundle() == 'service_request' && $node->id()) {
    // Get the new status from the field_status field.
    $newStatus = $node->field_status->target_id;
    
    // Get the original node to check if status has changed.
    $original = $node->original;
    $originalStatus = $original ? $original->field_status->target_id : null;
    
    // Only process if status has actually changed.
    if ($newStatus && $originalStatus && $newStatus != $originalStatus) {
      // Check if there are existing status notes.
      $hasStatusNotes = false;
      $lastParagraphStatus = null;
      
      if (!$node->field_status_notes->isEmpty()) {
        $hasStatusNotes = true;
        // Get the last paragraph to check its status.
        $lastParagraph = $node->field_status_notes->last()->entity;
        if ($lastParagraph && $lastParagraph->hasField('field_status_term')) {
          $lastParagraphStatus = $lastParagraph->field_status_term->target_id;
        }
      }
      
      // Create a new status note paragraph if:
      // 1. There are no status notes yet, OR
      // 2. The new status is different from the last paragraph's status
      if (!$hasStatusNotes || $newStatus != $lastParagraphStatus) {
        // Create a new paragraph for this status change.
        $status_note_text = t('Status changed.');
        
        $paragraph = Paragraph::create([
          'type' => 'status',
          'field_status_note' => [
            'value' => $status_note_text,
            'format' => 'plain_text',
          ],
          'field_status_term' => [
            'target_id' => $newStatus,
          ],
        ]);
        $paragraph->save();
        
        // Add the new paragraph to the status notes field.
        $node->field_status_notes->appendItem([
          'target_id' => $paragraph->id(),
          'target_revision_id' => $paragraph->getRevisionId(),
        ]);
      }
    }
  }

}

/**
 * Implements hook_form_alter().
 */
function service_request_form_alter(&$form, &$form_state, $form_id) {
  // $status_widget = $form['field_status_notes']['widget'];
  // todo:
  // Disable paragraph subform if subform hooks are stable:
  // https://www.drupal.org/project/paragraphs/issues/2868155
  $form['#attached']['library'][] = 'service_request/paragraphs';
  $form['#attached']['drupalSettings']['service_request']['paragraphs']['variable'] = 'value';

  return $form;
}
