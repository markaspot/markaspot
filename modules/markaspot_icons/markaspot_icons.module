<?php

/**
 * @file
 * Mark-a-Spot Icons module hooks and functions.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_field_widget_info_alter().
 */
function markaspot_icons_field_widget_info_alter(array &$info) {
  // Allow Iconify widget to work with fa_icon_class field type.
  if (isset($info['iconify_field_icon_picker'])) {
    $info['iconify_field_icon_picker']['field_types'][] = 'fa_icon_class';
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function markaspot_icons_field_widget_form_alter(&$element, FormStateInterface $form_state, $context) {
  $field_definition = $context['items']->getFieldDefinition();

  // Handle Iconify widget on fa_icon_class fields.
  if ($field_definition->getType() === 'fa_icon_class' &&
      $context['widget']->getPluginId() === 'iconify_field_icon_picker') {

    // Convert fa_icon_class field to work with Iconify widget.
    // The Iconify widget expects 'value' in the structure.
    if (isset($element['value'])) {
      // Convert FontAwesome format to Iconify format for display.
      $current_value = $element['value']['#default_value'] ?? '';
      if (!empty($current_value) && strpos($current_value, 'fa-') === 0) {
        $element['value']['#default_value'] = markaspot_icons_convert_fa_to_iconify($current_value);
      }
    }
  }
}

/**
 * Implements hook_field_widget_complete_form_alter().
 */
function markaspot_icons_field_widget_complete_form_alter(&$field_widget_complete_form, FormStateInterface $form_state, $context) {
  $field_definition = $context['items']->getFieldDefinition();

  if ($field_definition->getType() === 'fa_icon_class' &&
      $context['widget']->getPluginId() === 'iconify_field_icon_picker') {

    // Add custom validation to convert Iconify format back to FontAwesome format.
    $field_widget_complete_form['#element_validate'][] = 'markaspot_icons_iconify_to_fa_validate';
  }
}

/**
 * Custom validation to convert Iconify format to FontAwesome format.
 */
function markaspot_icons_iconify_to_fa_validate($element, FormStateInterface $form_state, $complete_form) {
  $values = $form_state->getValue($element['#parents']);

  if (!empty($values[0]['value'])) {
    $iconify_value = $values[0]['value'];

    // Convert Iconify format back to FontAwesome format for storage.
    if (strpos($iconify_value, 'i-') === 0) {
      $fa_value = markaspot_icons_convert_iconify_to_fa($iconify_value);
      $values[0]['value'] = $fa_value;
      $form_state->setValue($element['#parents'], $values);
    }
  }
}

/**
 * Convert FontAwesome icon to Iconify format (Lucide collection).
 */
function markaspot_icons_convert_fa_to_iconify($fa_icon) {
  $mapping = [
    // People/Users.
    'fa-male' => 'i-lucide-user',
    'fa-user' => 'i-lucide-user',
    'fa-users' => 'i-lucide-users',

    // Objects/Tools.
    'fa-lightbulb-o' => 'i-lucide-lightbulb',
    'fa-lightbulb' => 'i-lucide-lightbulb',
    'fa-glass' => 'i-lucide-wine',
    'fa-paint-brush' => 'i-lucide-paintbrush',
    'fa-circle-o' => 'i-lucide-circle',
    'fa-circle' => 'i-lucide-circle-dot',

    // Nature/Environment.
    'fa-tree' => 'i-lucide-tree-pine',
    'fa-leaf' => 'i-lucide-leaf',
    'fa-tint' => 'i-lucide-droplets',
    'fa-soccer-ball-o' => 'i-lucide-circle-dot',

    // Waste/Trash.
    'fa-trash' => 'i-lucide-trash',
    'fa-trash-o' => 'i-lucide-trash-2',

    // Transportation/Infrastructure.
    'fa-road' => 'i-lucide-construction',
    'fa-car' => 'i-lucide-car',
    'fa-bicycle' => 'i-lucide-bike',

    // Time.
    'fa-clock-o' => 'i-lucide-clock',
    'fa-clock' => 'i-lucide-clock',
    'fa-calendar-times-o' => 'i-lucide-calendar-x',

    // Communication.
    'fa-comment' => 'i-lucide-message-circle',
    'fa-comment-o' => 'i-lucide-message-circle',

    // Status indicators.
    'fa-check' => 'i-lucide-check',
    'fa-check-circle' => 'i-lucide-check-circle',
    'fa-play-circle' => 'i-lucide-play-circle',
    'fa-hand-stop-o' => 'i-lucide-hand',
    'fa-stack-overflow' => 'i-lucide-archive',

    // Buildings/Places.
    'fa-bank' => 'i-lucide-building-2',
    'fa-building' => 'i-lucide-building',
    'fa-home' => 'i-lucide-home',

    // Miscellaneous.
    'fa-heart-o' => 'i-lucide-heart',
    'fa-heart' => 'i-lucide-heart',
  ];

  return $mapping[$fa_icon] ?? 'i-lucide-alert-circle';
}

/**
 * Convert Iconify (Lucide) icon back to FontAwesome format.
 *
 * Note: This is primarily for backwards compatibility. New installations
 * should use Lucide icons directly without conversion.
 */
function markaspot_icons_convert_iconify_to_fa($iconify_icon) {
  $reverse_mapping = [
    // People/Users.
    'i-lucide-user' => 'fa-male',
    'i-lucide-users' => 'fa-users',

    // Objects/Tools.
    'i-lucide-lightbulb' => 'fa-lightbulb-o',
    'i-lucide-wine' => 'fa-glass',
    'i-lucide-paintbrush' => 'fa-paint-brush',
    'i-lucide-circle' => 'fa-circle-o',
    'i-lucide-circle-dot' => 'fa-circle',

    // Nature/Environment.
    'i-lucide-tree-pine' => 'fa-tree',
    'i-lucide-leaf' => 'fa-leaf',
    'i-lucide-droplets' => 'fa-tint',

    // Waste/Trash.
    'i-lucide-trash' => 'fa-trash',
    'i-lucide-trash-2' => 'fa-trash-o',

    // Transportation/Infrastructure.
    'i-lucide-construction' => 'fa-road',
    'i-lucide-car' => 'fa-car',
    'i-lucide-bike' => 'fa-bicycle',

    // Time.
    'i-lucide-clock' => 'fa-clock-o',
    'i-lucide-calendar-x' => 'fa-calendar-times-o',

    // Communication.
    'i-lucide-message-circle' => 'fa-comment',

    // Status indicators.
    'i-lucide-check' => 'fa-check',
    'i-lucide-check-circle' => 'fa-check-circle',
    'i-lucide-play-circle' => 'fa-play-circle',
    'i-lucide-hand' => 'fa-hand-stop-o',
    'i-lucide-archive' => 'fa-stack-overflow',

    // Buildings/Places.
    'i-lucide-building-2' => 'fa-bank',
    'i-lucide-building' => 'fa-building',
    'i-lucide-home' => 'fa-home',

    // Miscellaneous.
    'i-lucide-heart' => 'fa-heart',

    // Default fallback.
    'i-lucide-alert-circle' => 'fa-exclamation-circle',
  ];

  return $reverse_mapping[$iconify_icon] ?? 'fa-question-circle';
}
