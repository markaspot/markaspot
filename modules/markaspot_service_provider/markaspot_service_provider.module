<?php

/**
 * @file
 * Contains markaspot_service_provider.module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function markaspot_service_provider_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.markaspot_service_provider':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Mark-a-Spot Service Provider module provides functionality for service providers to respond to and complete service requests.') . '</p>';
      $output .= '<h3>' . t('Features') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Service provider completion tracking') . '</li>';
      $output .= '<li>' . t('Multi-value completion notes with metadata') . '</li>';
      $output .= '<li>' . t('Email validation against service provider records') . '</li>';
      $output .= '<li>' . t('Status management for completed work') . '</li>';
      $output .= '<li>' . t('Support for reassignment workflow') . '</li>';
      $output .= '</ul>';
      $output .= '<h3>' . t('Email Notifications') . '</h3>';
      $output .= '<p>' . t('Email notifications to service providers are handled via ECA (Event-Condition-Action) rules, similar to the markaspot_resubmission module. Configure ECA to send notifications when service providers are assigned to service requests.') . '</p>';
      $output .= '<h3>' . t('Cron Notifications') . '</h3>';
      $output .= '<p>' . t('Optionally enable periodic notifications to service providers about pending requests. This requires cron to be running and ECA rules to be configured for sending the actual notifications.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave() for node entities.
 *
 * Automatically formats moderator notes added to field_service_provider_notes.
 * When a moderator/admin adds a note via the Drupal UI, this hook ensures
 * the note follows the standard format: message first, then metadata footer.
 */
function markaspot_service_provider_node_presave(\Drupal\node\NodeInterface $node) {
  if ($node->bundle() !== 'service_request') {
    return;
  }

  if (!$node->hasField('field_service_provider_notes')) {
    return;
  }

  // Only process if user is logged in (not API/anonymous).
  $current_user = \Drupal::currentUser();
  if ($current_user->isAnonymous()) {
    return;
  }

  // Check if this is a moderator/admin (has edit permission).
  if (!$current_user->hasPermission('edit any service_request content')) {
    return;
  }

  // Skip if this is an API request (check for specific header or context).
  $request = \Drupal::request();
  $content_type = $request->headers->get('Content-Type', '');
  if (strpos($content_type, 'application/json') !== false) {
    // API request - let the controller handle formatting.
    return;
  }

  // Get current and original notes.
  $current_notes = $node->get('field_service_provider_notes')->getValue();
  $original_notes = [];

  if (!$node->isNew() && $node->original) {
    $original_notes = $node->original->get('field_service_provider_notes')->getValue();
  }

  // Find new notes (compare counts - new notes are appended).
  $original_count = count($original_notes);
  $current_count = count($current_notes);

  if ($current_count <= $original_count) {
    // No new notes added.
    return;
  }

  // Process each new note.
  $date_formatter = \Drupal::service('date.formatter');
  $username = $current_user->getDisplayName();
  $timestamp = $date_formatter->format(\Drupal::time()->getRequestTime(), 'custom', 'd.m.Y - H:i', 'Europe/Berlin');

  for ($i = $original_count; $i < $current_count; $i++) {
    $note_value = $current_notes[$i]['value'] ?? '';

    // Skip if empty or already has metadata footer.
    if (empty($note_value) || strpos($note_value, '---') !== false) {
      continue;
    }

    // Strip HTML tags for plain text processing, then re-add.
    $plain_text = strip_tags($note_value);
    $plain_text = trim($plain_text);

    if (empty($plain_text)) {
      continue;
    }

    // Build formatted note with source marker and metadata footer.
    $metadata_footer = "\n\n---\n" .
      t('R端ckmeldung von: @username', ['@username' => $username]) . "\n" .
      t('Datum: @timestamp', ['@timestamp' => $timestamp]);

    // Add source marker for language-agnostic parsing.
    $formatted_note = '<!-- source:moderator -->' . $plain_text . $metadata_footer;
    $formatted_note_html = nl2br($formatted_note, false);

    // Update the note.
    $current_notes[$i]['value'] = $formatted_note_html;
    $current_notes[$i]['format'] = 'basic_html';
  }

  // Save updated notes back to the field.
  $node->set('field_service_provider_notes', $current_notes);
}

/**
 * Implements hook_cron().
 */
function markaspot_service_provider_cron() {
  $config = \Drupal::config('markaspot_service_provider.settings');

  // Check if cron notifications are enabled.
  $enabled = $config->get('enable_cron_notifications');
  if (!$enabled) {
    return;
  }

  // Get the interval setting (default to 1 hour).
  $interval = $config->get('cron_interval');
  $interval = !empty($interval) ? $interval : 3600;

  // Check if it's time to run based on the interval.
  $next_execution = \Drupal::state()
    ->get('markaspot_service_provider.next_execution', 0);

  if (\Drupal::time()->getRequestTime() >= $next_execution) {
    $entity_type_manager = \Drupal::entityTypeManager();
    $node_storage = $entity_type_manager->getStorage('node');

    // Find service requests with assigned service providers.
    // You can customize this query based on your specific needs.
    $query = $node_storage->getQuery()
      ->condition('type', 'service_request')
      ->condition('status', 1)
      ->exists('field_service_provider')
      ->accessCheck(FALSE);

    $nids = $query->execute();
    $count = count($nids);

    if ($count > 0) {
      // Dispatch an event or trigger ECA rules here.
      // For now, just log that nodes are ready for notification.
      \Drupal::logger('markaspot_service_provider')
        ->notice('Found @count service requests with assigned providers ready for cron notification.',
          ['@count' => $count]);

      // @todo Implement event dispatching or queue worker for ECA integration.
    }

    // Set the next execution time.
    \Drupal::state()
      ->set('markaspot_service_provider.next_execution',
        \Drupal::time()->getRequestTime() + $interval);
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for service request edit form.
 */
function markaspot_service_provider_form_node_service_request_edit_form_alter(array &$form, FormStateInterface $form_state, $form_id): void {
  _markaspot_service_provider_render_notes_readonly($form, $form_state);
}

/**
 * Implements hook_form_FORM_ID_alter() for service request management form.
 */
function markaspot_service_provider_form_node_service_request_management_form_alter(array &$form, FormStateInterface $form_state, $form_id): void {
  _markaspot_service_provider_render_notes_readonly($form, $form_state);
}

/**
 * Renders service provider notes as read-only markup for non-admin users.
 *
 * For users without 'administer nodes' permission, this replaces the editable
 * textarea widget with a read-only display of all notes, and adds a separate
 * textarea for adding new moderator responses.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _markaspot_service_provider_render_notes_readonly(array &$form, FormStateInterface $form_state): void {
  $current_user = \Drupal::currentUser();

  // Allow admins to edit directly.
  if ($current_user->hasPermission('administer nodes')) {
    return;
  }

  if (!isset($form['field_service_provider_notes']['widget'])) {
    return;
  }

  $form_object = $form_state->getFormObject();
  $node = $form_object->getEntity();

  if (!$node || !$node->hasField('field_service_provider_notes')) {
    return;
  }

  // Get ALL values from the multi-value field.
  $all_values = $node->get('field_service_provider_notes')->getValue();
  $widget_title = $form['field_service_provider_notes']['widget']['#title'] ?? t('Service Provider Notes');

  // Build render array for all existing notes.
  $notes_render = [];
  if (!empty($all_values)) {
    foreach ($all_values as $index => $item) {
      $value = $item['value'] ?? '';
      $format = $item['format'] ?? 'plain_text';
      if (!empty($value)) {
        $notes_render[] = [
          '#type' => 'container',
          '#attributes' => [
            'class' => ['sp-note-item'],
            'style' => 'margin-bottom: 1em; padding: 0.5em; background: var(--gin-bg-layer2, #f5f5f5); border-radius: 4px;',
          ],
          'index' => [
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#value' => t('Entry @num', ['@num' => $index + 1]),
            '#attributes' => [
              'class' => ['sp-note-index'],
              'style' => 'font-size: 0.8em; color: #666; margin-bottom: 0.5em;',
            ],
          ],
          'content' => [
            '#type' => 'processed_text',
            '#text' => $value,
            '#format' => $format,
          ],
        ];
      }
    }
  }

  // Replace widget with read-only display.
  if (!empty($notes_render)) {
    $form['field_service_provider_notes']['widget'] = [
      '#type' => 'item',
      '#title' => $widget_title,
      '#wrapper_attributes' => ['class' => ['field-service-provider-notes-readonly']],
      'notes' => $notes_render,
    ];
  }
  else {
    $form['field_service_provider_notes']['widget'] = [
      '#type' => 'item',
      '#title' => $widget_title,
      '#markup' => '<em>' . t('No notes from service provider.') . '</em>',
      '#wrapper_attributes' => ['class' => ['field-service-provider-notes-readonly']],
    ];
  }

  // Add separate textarea for moderator response.
  $form['moderator_response_to_sp'] = [
    '#type' => 'textarea',
    '#title' => t('R端ckmeldung an den Dienstleister'),
    '#description' => t('Diese Nachricht wird als neuer Eintrag hinzugef端gt.'),
    '#rows' => 4,
    '#weight' => ($form['field_service_provider_notes']['#weight'] ?? 0) + 0.1,
    '#group' => 'group_service_provider',
    '#attributes' => ['class' => ['moderator-response-field']],
  ];

  // Store ALL original values as JSON for submit handler.
  $form['field_service_provider_notes_all_values'] = [
    '#type' => 'hidden',
    '#value' => json_encode($all_values),
  ];

  // Add submit handler to merge the response.
  array_unshift($form['actions']['submit']['#submit'], '_markaspot_service_provider_merge_notes_submit');
}

/**
 * Submit handler to merge moderator response into service provider notes.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function _markaspot_service_provider_merge_notes_submit(array &$form, FormStateInterface $form_state): void {
  $response = $form_state->getValue('moderator_response_to_sp') ?? '';
  $all_values_json = $form_state->getValue('field_service_provider_notes_all_values') ?? '[]';
  $all_values = json_decode($all_values_json, TRUE) ?: [];

  if (!empty(trim($response))) {
    $user = \Drupal::currentUser();
    $timestamp = \Drupal::service('date.formatter')->format(time(), 'custom', 'd.m.Y - H:i', 'Europe/Berlin');

    // Build the formatted note with source marker and metadata footer.
    $message_html = nl2br(htmlspecialchars($response));
    $metadata_footer = "<br><br>---<br>" .
      t('R端ckmeldung von: @username', ['@username' => $user->getDisplayName()]) . "<br>" .
      t('Datum: @timestamp', ['@timestamp' => $timestamp]);

    // Add source marker for language-agnostic parsing.
    $formatted_note = '<!-- source:moderator -->' . $message_html . $metadata_footer;

    // Add as a NEW entry.
    $all_values[] = [
      'value' => $formatted_note,
      'format' => 'basic_html',
    ];
  }

  // Set all values back to the field.
  $form_state->setValue('field_service_provider_notes', $all_values);
}
