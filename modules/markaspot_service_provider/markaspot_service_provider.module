<?php

/**
 * @file
 * Contains markaspot_service_provider.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function markaspot_service_provider_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.markaspot_service_provider':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Mark-a-Spot Service Provider module provides functionality for service providers to respond to and complete service requests.') . '</p>';
      $output .= '<h3>' . t('Features') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Service provider completion tracking') . '</li>';
      $output .= '<li>' . t('Multi-value completion notes with metadata') . '</li>';
      $output .= '<li>' . t('Email validation against service provider records') . '</li>';
      $output .= '<li>' . t('Status management for completed work') . '</li>';
      $output .= '<li>' . t('Support for reassignment workflow') . '</li>';
      $output .= '</ul>';
      $output .= '<h3>' . t('Email Notifications') . '</h3>';
      $output .= '<p>' . t('Email notifications to service providers are handled via ECA (Event-Condition-Action) rules, similar to the markaspot_resubmission module. Configure ECA to send notifications when service providers are assigned to service requests.') . '</p>';
      $output .= '<h3>' . t('Cron Notifications') . '</h3>';
      $output .= '<p>' . t('Optionally enable periodic notifications to service providers about pending requests. This requires cron to be running and ECA rules to be configured for sending the actual notifications.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave() for node entities.
 *
 * Automatically formats moderator notes added to field_service_provider_notes.
 * When a moderator/admin adds a note via the Drupal UI, this hook ensures
 * the note follows the standard format: message first, then metadata footer.
 */
function markaspot_service_provider_node_presave(\Drupal\node\NodeInterface $node) {
  if ($node->bundle() !== 'service_request') {
    return;
  }

  if (!$node->hasField('field_service_provider_notes')) {
    return;
  }

  // Only process if user is logged in (not API/anonymous).
  $current_user = \Drupal::currentUser();
  if ($current_user->isAnonymous()) {
    return;
  }

  // Check if this is a moderator/admin (has edit permission).
  if (!$current_user->hasPermission('edit any service_request content')) {
    return;
  }

  // Skip if this is an API request (check for specific header or context).
  $request = \Drupal::request();
  $content_type = $request->headers->get('Content-Type', '');
  if (strpos($content_type, 'application/json') !== false) {
    // API request - let the controller handle formatting.
    return;
  }

  // Get current and original notes.
  $current_notes = $node->get('field_service_provider_notes')->getValue();
  $original_notes = [];

  if (!$node->isNew() && $node->original) {
    $original_notes = $node->original->get('field_service_provider_notes')->getValue();
  }

  // Find new notes (compare counts - new notes are appended).
  $original_count = count($original_notes);
  $current_count = count($current_notes);

  if ($current_count <= $original_count) {
    // No new notes added.
    return;
  }

  // Process each new note.
  $date_formatter = \Drupal::service('date.formatter');
  $username = $current_user->getDisplayName();
  $timestamp = $date_formatter->format(\Drupal::time()->getRequestTime(), 'custom', 'd.m.Y - H:i', 'Europe/Berlin');

  for ($i = $original_count; $i < $current_count; $i++) {
    $note_value = $current_notes[$i]['value'] ?? '';

    // Skip if empty or already has metadata footer.
    if (empty($note_value) || strpos($note_value, '---') !== false) {
      continue;
    }

    // Strip HTML tags for plain text processing, then re-add.
    $plain_text = strip_tags($note_value);
    $plain_text = trim($plain_text);

    if (empty($plain_text)) {
      continue;
    }

    // Build formatted note with source marker and metadata footer.
    $metadata_footer = "\n\n---\n" .
      t('RÃ¼ckmeldung von: @username', ['@username' => $username]) . "\n" .
      t('Datum: @timestamp', ['@timestamp' => $timestamp]);

    // Add source marker for language-agnostic parsing.
    $formatted_note = '<!-- source:moderator -->' . $plain_text . $metadata_footer;
    $formatted_note_html = nl2br($formatted_note, false);

    // Update the note.
    $current_notes[$i]['value'] = $formatted_note_html;
    $current_notes[$i]['format'] = 'basic_html';
  }

  // Save updated notes back to the field.
  $node->set('field_service_provider_notes', $current_notes);
}

/**
 * Implements hook_cron().
 */
function markaspot_service_provider_cron() {
  $config = \Drupal::config('markaspot_service_provider.settings');

  // Check if cron notifications are enabled.
  $enabled = $config->get('enable_cron_notifications');
  if (!$enabled) {
    return;
  }

  // Get the interval setting (default to 1 hour).
  $interval = $config->get('cron_interval');
  $interval = !empty($interval) ? $interval : 3600;

  // Check if it's time to run based on the interval.
  $next_execution = \Drupal::state()
    ->get('markaspot_service_provider.next_execution', 0);

  if (\Drupal::time()->getRequestTime() >= $next_execution) {
    $entity_type_manager = \Drupal::entityTypeManager();
    $node_storage = $entity_type_manager->getStorage('node');

    // Find service requests with assigned service providers.
    // You can customize this query based on your specific needs.
    $query = $node_storage->getQuery()
      ->condition('type', 'service_request')
      ->condition('status', 1)
      ->exists('field_service_provider')
      ->accessCheck(FALSE);

    $nids = $query->execute();
    $count = count($nids);

    if ($count > 0) {
      // Dispatch an event or trigger ECA rules here.
      // For now, just log that nodes are ready for notification.
      \Drupal::logger('markaspot_service_provider')
        ->notice('Found @count service requests with assigned providers ready for cron notification.',
          ['@count' => $count]);

      // @todo Implement event dispatching or queue worker for ECA integration.
    }

    // Set the next execution time.
    \Drupal::state()
      ->set('markaspot_service_provider.next_execution',
        \Drupal::time()->getRequestTime() + $interval);
  }
}
